<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>Ajouter Étudiant — Attendance System</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="../css/mobile-first.css">
  <link rel="stylesheet" href="../css/components.css">
  <link rel="stylesheet" href="../css/style.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
  <div class="container">
    <header class="header card">
      <div class="brand">
        <div class="logo">AS</div>
        <div>
          <div class="site-title">Ajouter étudiant</div>
          <div class="small">Formulaire</div>
        </div>
      </div>
      <nav class="nav">
        <a href="index.html">Accueil</a>
        <a href="attendance.html">Prise présence</a>
        <a href="reports.html">Rapports</a>
      </nav>
    </header>

    <main class="card" style="margin-top:12px;max-width:720px">
      <form id="addStudentForm" class="form">
        <div class="form-row">
          <label for="stuId">Matricule</label>
          <input id="stuId" name="stuId" class="input" placeholder="ex: 2021001" required>
          <div id="errId" class="form-error"></div>
        </div>
        <div class="form-row">
          <label for="lastName">Nom</label>
          <input id="lastName" name="lastName" class="input" required>
          <div id="errLast" class="form-error"></div>
        </div>
        <div class="form-row">
          <label for="firstName">Prénom</label>
          <input id="firstName" name="firstName" class="input" required>
          <div id="errFirst" class="form-error"></div>
        </div>
        <div class="form-row">
          <label for="email">Email</label>
          <input id="email" name="email" class="input" type="email" required>
          <div id="errEmail" class="form-error"></div>
        </div>

        <div style="display:flex;gap:8px;align-items:center;margin-top:6px">
          <button class="button" type="submit">Ajouter</button>
          <button id="clearForm" type="button" class="btn-ghost">Effacer</button>
          <span id="addConfirm" class="small" style="color:var(--success);display:none">Étudiant ajouté ✓</span>
        </div>
      </form>
    </main>
  </div>

<script>
$(function(){
  function clearErrors(){ $('#errId,#errLast,#errFirst,#errEmail').text(''); }
  function validateForm(){
    clearErrors();
    let ok = true;
    const id = $('#stuId').val().trim();
    const last = $('#lastName').val().trim();
    const first = $('#firstName').val().trim();
    const email = $('#email').val().trim();
    if(id === '' || !/^\d+$/.test(id)){ $('#errId').text('Matricule requis (chiffres uniquement).'); ok=false; }
    if(last === '' || !/^[A-Za-zÀ-ÖØ-öø-ÿ\'\-\s]+$/.test(last)){ $('#errLast').text('Nom requis (lettres).'); ok=false; }
    if(first === '' || !/^[A-Za-zÀ-ÖØ-öø-ÿ\'\-\s]+$/.test(first)){ $('#errFirst').text('Prénom requis (lettres).'); ok=false; }
    if(email === '' || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)){ $('#errEmail').text('Email invalide.'); ok=false; }
    return ok;
  }

  $('#addStudentForm').on('submit', async function(e){
    e.preventDefault();
    if(!validateForm()) return;
    const fd = new FormData();
    fd.append('student_id', $('#stuId').val().trim());
    fd.append('last_name', $('#lastName').val().trim());
    fd.append('first_name', $('#firstName').val().trim());
    fd.append('email', $('#email').val().trim());
    try {
      const res = await fetch('../php/students/add_student.php', {method:'POST', body:fd});
      const text = await res.text();
      // php returns plain text message in our implementation
      $('#addConfirm').text(text).show().delay(1600).fadeOut(400);
      // reset form if success message contains 'succ' or 'ajout'
      if(/succ/i.test(text) || /ajout/i.test(text) || /ajouté/i.test(text)) $('#addStudentForm')[0].reset();
    } catch(e){
      $('#addConfirm').text('Erreur: '+e.message).css('color','var(--danger)').show().delay(2000).fadeOut(400);
    }
  });

  $('#clearForm').on('click', function(){ $('#addStudentForm')[0].reset(); clearErrors(); });
});
</script>
</body>
</html>
